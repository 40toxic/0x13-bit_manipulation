More function work and nested loops